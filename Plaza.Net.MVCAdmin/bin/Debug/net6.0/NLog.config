<?xml version="1.0" encoding="utf-8" ?>
<nlog xmlns="http://www.nlog-project.org/schemas/NLog.xsd"
      xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
      autoReload="true">

  <extensions>
    <add assembly="NLog.Web.AspNetCore"/>
  </extensions>

  <targets>
    <!-- 登录日志数据库记录目标 -->
    <target name="loginDatabase" xsi:type="Database"
            dbProvider="System.Data.SqlClient"
            connectionString="Server=.;Database=PlazaDB;UId=sa;Password=123456">
      <commandText>
        INSERT INTO PlazaDB.dbo.LoginLog (
        LoginTime, LogoutTime, IPAddress, DeviceInfo, Status,
        FailureReason, UserId, Code, IsDeleted, CreateTime, UpdateTime
        ) VALUES (
        @LoginTime, @LogoutTime, @IPAddress, @DeviceInfo, @Status,
        @FailureReason, @UserId, @Code, @IsDeleted, @CreateTime, @UpdateTime
        );
      </commandText>

      <parameter name="@LoginTime" layout="${date}" />
      <parameter name="@LogoutTime" layout="${date}" />
      <parameter name="@IPAddress" layout="${aspnet-request-ip}" />
      <parameter name="@DeviceInfo" layout="${aspnet-request-useragent}" />
      <parameter name="@Status" layout="${event-properties:item=Status}" />
      <parameter name="@FailureReason" layout="${event-properties:item=FailureReason}" />
      <parameter name="@UserId" layout="${event-properties:item=UserId}" />
      <parameter name="@Code" layout="${event-properties:item=Code}" />
      <parameter name="@IsDeleted" layout="0" />
      <parameter name="@CreateTime" layout="${date}" />
      <parameter name="@UpdateTime" layout="${date}" />
    </target>

    <!-- 操作日志数据库记录目标 -->
    <target name="operationDatabase" xsi:type="Database"
            dbProvider="System.Data.SqlClient"
            connectionString="Server=.;Database=PlazaDB;UId=sa;Password=123456">
      <commandText>
        INSERT INTO PlazaDB.dbo.OperationLog (
        OperationTime, OperationType, Module, Target, Details,
        IPAddress, Status, ExecutionTime, UserId, Code, IsDeleted, CreateTime, UpdateTime
        ) VALUES (
        @OperationTime, @OperationType, @Module, @Target, @Details,
        @IPAddress, @Status, @ExecutionTime, @UserId, @Code, @IsDeleted, @CreateTime, @UpdateTime
        );
      </commandText>

      <parameter name="@OperationTime" layout="${date}" />
      <parameter name="@OperationType" layout="${event-properties:item=OperationType}" />
      <parameter name="@Module" layout="${event-properties:item=Module}" />
      <parameter name="@Target" layout="${event-properties:item=Target}" />
      <parameter name="@Details" layout="${event-properties:item=Details}" />
      <parameter name="@IPAddress" layout="${aspnet-request-ip}" />
      <parameter name="@Status" layout="${event-properties:item=Status}" />
      <parameter name="@ExecutionTime" layout="${event-properties:item=ExecutionTime}" />
      <parameter name="@UserId" layout="${event-properties:item=UserId}" />
      <parameter name="@Code" layout="${event-properties:item=Code}" />
      <parameter name="@IsDeleted" layout="0" />
      <parameter name="@CreateTime" layout="${date}" />
      <parameter name="@UpdateTime" layout="${date}" />
    </target>

    <!-- 可选：文件记录目标 -->
    <target name="file" xsi:type="File" fileName="${basedir}/App_Data/nlog/${date:format=yyyy-MM}/${level}-${shortdate}.csv" encoding="utf-8" >
      <layout xsi:type="CSVLayout">
        <column name="date" layout="${date}" />
        <column name="LogTitle" layout="${event-properties:item=LogTitle}" />
        <column name="message" layout="${message}" />
        <column name="exception" layout="${exception:format=tostring}" />
        <column name="machinename" layout="${machinename}" />
        <column name="appdomain" layout="${appdomain}" />
        <column name="assembly-version" layout=" ${assembly-version}" />
        <column name="basedir" layout="${basedir}" />
        <column name="callsite" layout="${callsite}" />
        <column name="counter" layout="${counter}" />
        <column name="nlogdir" layout="${nlogdir}" />
        <column name="processid" layout="${processid}" />
        <column name="processname" layout="${processname}" />
        <column name="specialfolder" layout="${specialfolder}" />
        <column name="stacktrace" layout="${stacktrace}" />
        <column name="longdate" layout="${longdate}" />
        <column name="event-properties" layout="${event-properties:item=EventId_Id}" />
        <column name="uppercase" layout="${uppercase:${level}}" />
        <column name="logger" layout="${logger}" />
        <column name="url" layout="${aspnet-request-url}" />
        <column name="action" layout="${aspnet-mvc-action}" />
      </layout>
    </target>
  </targets>

  <rules>
    <!-- 记录登录日志到数据库 -->
    <logger name="LoginLogger" minlevel="Info" writeTo="loginDatabase" />
    <!-- 记录操作日志到数据库 -->
    <logger name="OperationLogger" minlevel="Info" writeTo="operationDatabase" />
    <!-- 可选：同时记录到文件 -->
    <logger name="*" minlevel="Info" writeTo="file" />
  </rules>
</nlog>
