@{
ViewData["Title"] = "广场管理";
}

<div class="container-fluid">
	<!-- 主内容容器 -->
	<div class="row">
		<div class="col-lg-12">
			<!-- 卡片式布局 -->
			<div class="card shadow-sm">

				<!-- 卡片主体 -->
				<div class="card-body">
					<!-- 选项卡导航 -->
					<nav>
						<div class="nav nav-tabs mb-3" id="nav-tab" role="tablist">
							<button class="nav-link active" id="nav-list-tab" data-bs-toggle="tab"
								data-bs-target="#nav-list" type="button" role="tab" aria-controls="nav-list"
								aria-selected="true">广场列表</button>
							<button class="nav-link" id="nav-stats-tab" data-bs-toggle="tab" data-bs-target="#nav-stats"
								type="button" role="tab" aria-controls="nav-stats" aria-selected="false">统计信息</button>
							<button class="nav-link" id="nav-about-tab" data-bs-toggle="tab" data-bs-target="#nav-about"
								type="button" role="tab" aria-controls="nav-about" aria-selected="false">关于广场</button>
						</div>
					</nav>

					<div class="tab-content" id="nav-tabContent">
						<!-- 广场列表标签页 -->
						<div class="tab-pane fade show active" id="nav-list" role="tabpanel"
							aria-labelledby="nav-list-tab">
							<!-- 工具栏区域 -->
							<div id="toolbar" class="d-flex justify-content-between align-items-center mb-3">
								<!-- 操作按钮组 -->
								<div class="btn-group me-2 mb-2 mb-lg-0">
									<button class="btn btn-success btn-sm btn-round" onclick="add()">
										<span class="mdi mdi-plus me-1"></span> 新增
									</button>
									<button id="edit-btn" class="btn btn-primary btn-sm btn-round edit-btn" disabled>
										<span class="mdi mdi-pencil me-1"></span> 编辑
									</button>
									<button id="del-btn" class="btn btn-danger btn-sm btn-round del-btn" disabled>
										<span class="mdi mdi-close me-1"></span> 删除
									</button>
								</div>
								<!-- 搜索区域 -->
								<div class="input-group d-flex justify-content-center">
									<button id="searchplus-btn" class="btn btn-outline-secondary btn-sm btn-round"
										data-bs-toggle="modal" data-bs-target="#searchModal">
										<span class="mdi mdi-magnify-plus"></span>高级搜索
									</button>
									<input type="text" id="searchBox" class="form-control form-control-sm"
										placeholder="搜索...">
									<button id="searchButton" class="btn btn-outline-secondary btn-sm btn-round">
										<span class="mdi mdi-magnify"></span>查询
									</button>
									<button class="btn btn-outline-secondary btn-sm btn-round" id="clearButton">
										<span class="mdi mdi-delete"></span>清除
									</button>
								</div>
							</div>
							<!-- 表格响应区域 -->
							<div class="table-responsive">
								<!-- 数据表格 -->
								<table id="table" class="table table-hover table-striped align-middle"
									style="text-align:center;"></table>
							</div>
						</div>

						<!-- 统计信息标签页 -->
						<div class="tab-pane fade" id="nav-stats" role="tabpanel" aria-labelledby="nav-stats-tab">

						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
</div>

<!-- 高级搜索模态框 -->
<div class="modal fade" id="searchModal" tabindex="-1" aria-hidden="true">
	<div class="modal-dialog modal-lg">
		<div class="modal-content">
			<div class="modal-header bg-light">
				<h5 class="modal-title">高级搜索</h5>
				<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
			</div>
			<div class="modal-body">
				<!-- 高级搜索表单 -->
				<form id="searchForm">
					<div class="row g-3">
						<div class="col-md-6">
							<label class="form-label">广场名称</label>
							<input type="text" class="form-control" name="plazaName" id="searchName">
						</div>
						<div class="col-md-6">
							<label class="form-label">广场地址</label>
							<input type="text" class="form-control" name="plazaAddress" id="searchAddress">
						</div>
					</div>
					<div class="col-md-6">
						<label class="form-label">状态</label>
						<select class="form-select" name="status" id="searchStatus">
							<option value="">全部</option>
							<option value="0">启用</option>
							<option value="1">禁用</option>
						</select>
					</div>
				</form>
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-outline-secondary btn-sm" onclick="resetSearchForm()">重置</button>
				<button type="button" class="btn btn-primary btn-sm" onclick="submitSearchForm()">搜索</button>
			</div>
		</div>
	</div>
</div>

<!-- 统一的信息管理模态框（新增/编辑） -->
<div class="modal fade" id="infoModal" tabindex="-1" aria-hidden="true">
	<div class="modal-dialog modal-lg">
		<div class="modal-content">
			<div class="modal-header bg-light">
				<h5 class="modal-title" id="infoModalTitle">新增信息</h5>
				<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
			</div>
			<div class="modal-body">
				<!-- 信息表单 -->
				<form id="infoForm">
					<input type="hidden" name="id" id="info-id">
					<div class="row g-3">
						<div class="col-md-6">
							<label class="form-label">广场名称 <span class="text-danger">*</span></label>
							<input type="text" class="form-control" name="name" id="info-name" required>
						</div>
						<div class="col-md-6">
							<label class="form-label">地址 <span class="text-danger">*</span></label>
							<input type="text" class="form-control" name="address" id="info-address" required>
						</div>
						<!-- 地图位置信息卡片 -->
						<div class="col-12">
							<div class="card">
								<div class="card-header bg-light">
									<h6 class="mb-0">位置信息</h6>
								</div>
								<div class="card-body p-3">
									<!-- 地图容器 -->
									<div id="mapContainer" class="map rounded" style="width:100%;height:300px;"></div>
									<div class="row mt-3 g-3">
										<div class="col-md-6">
											<label class="form-label">纬度 <span class="text-danger">*</span></label>
											<input type="text" class="form-control" readonly name="latitude"
												id="info-latitude" required>
										</div>
										<div class="col-md-6">
											<label class="form-label">经度 <span class="text-danger">*</span></label>
											<input type="text" class="form-control" readonly name="longitude"
												id="info-longitude" required>
										</div>
									</div>
								</div>
							</div>
						</div>
						<div class="col-md-6">
							<label class="form-label">唯一标识 <span class="text-danger">*</span></label>
							<input type="text" class="form-control" name="code" id="info-code" required>
						</div>
						<div class="col-md-6">
							<label class="form-label">状态</label>
							<select class="form-select" name="isDeleted" id="info-isDeleted">
								<option value="0">启用</option>
								<option value="1">禁用</option>
							</select>
						</div>
						<div class="col-md-6">
							<label class="form-label">创建时间</label>
							<input type="text" class="form-control" readonly name="createTime" id="info-createTime">
						</div>
						<div class="col-md-6">
							<label class="form-label">删除时间</label>
							<input type="text" class="form-control" readonly name="deleteTime" id="info-deleteTime">
						</div>
					</div>
				</form>
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-outline-secondary btn-sm" data-bs-dismiss="modal">取消</button>
				<button type="button" class="btn btn-primary btn-sm" onclick="submitInfoForm()">提交</button>
			</div>
		</div>
	</div>
</div>

<!-- 删除确认模态框 -->
<div class="modal fade" id="deleteConfirmModal" tabindex="-1" aria-hidden="true">
	<div class="modal-dialog">
		<div class="modal-content">
			<div class="modal-header bg-light">
				<h5 class="modal-title">确认删除</h5>
				<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
			</div>
			<div class="modal-body">
				<div class="d-flex align-items-center">
					<div class="me-3">
						<span class="mdi mdi-alert-circle text-danger" style="font-size: 1.5rem;"></span>
					</div>
					<div>
						<p class="mb-1">确定要删除选中的记录吗？</p>
						<p id="deleteCountInfo" class="text-muted small mb-0"></p>
					</div>
				</div>
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-outline-secondary btn-sm" data-bs-dismiss="modal">取消</button>
				<button type="button" class="btn btn-danger btn-sm" onclick="confirmDelete()">确认删除</button>
			</div>
		</div>
	</div>
</div>

<!-- 详情模态框 -->
<div class="modal fade" id="detailModal" tabindex="-1" aria-hidden="true">
	<div class="modal-dialog modal-lg">
		<div class="modal-content">
			<div class="modal-header bg-light">
				<h5 class="modal-title">详情信息</h5>
				<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
			</div>
			<div class="modal-body">
				<div class="row">
					<!-- 左侧信息列 -->
					<div class="col-md-6">
						<div class="mb-3">
							<label class="form-label text-muted">编号:</label>
							<div class="form-control-plaintext" id="detail-id">-</div>
						</div>
						<div class="mb-3">
							<label class="form-label text-muted">商场名称:</label>
							<div class="form-control-plaintext" id="detail-name">-</div>
						</div>
						<div class="mb-3">
							<label class="form-label text-muted">地址:</label>
							<div class="form-control-plaintext" id="detail-address">-</div>
						</div>
						<div class="mb-3">
							<label class="form-label text-muted">纬度:</label>
							<div class="form-control-plaintext" id="detail-latitude">-</div>
						</div>
						<div class="mb-3">
							<label class="form-label text-muted">创建时间:</label>
							<div class="form-control-plaintext" id="detail-createTime">-</div>
						</div>
						<div class="mb-3">
							<label class="form-label text-muted">状态:</label>
							<div class="form-control-plaintext" id="detail-isDeleted">-</div>
						</div>
					</div>

					<!-- 右侧信息列 -->
					<div class="col-md-6">
						<div class="mb-3">
							<label class="form-label text-muted">经度:</label>
							<div class="form-control-plaintext" id="detail-longitude">-</div>
						</div>
						<div class="mb-3">
							<label class="form-label text-muted">唯一标识:</label>
							<div class="form-control-plaintext" id="detail-code">-</div>
						</div>
						<div class="mb-3">
							<label class="form-label text-muted">更新时间:</label>
							<div class="form-control-plaintext" id="detail-updatetime">-</div>
						</div>
						<div class="mb-3">
							<label class="form-label text-muted">删除时间:</label>
							<div class="form-control-plaintext" id="detail-deletetime">-</div>
						</div>
					</div>
				</div>
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-outline-secondary btn-sm" data-bs-dismiss="modal">关闭</button>
			</div>
		</div>
	</div>
</div>

<!-- 经纬度模态框 -->
<div class="modal fade" id="coordinatesModal" tabindex="-1" aria-hidden="true">
	<div class="modal-dialog">
		<div class="modal-content">
			<div class="modal-header bg-light">
				<h5 class="modal-title">经纬度信息</h5>
				<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
			</div>
			<div class="modal-body p-0">
				<!-- 经纬度地图容器 -->
				<div id="coordinatesMap" style="width:100%; height:400px;"></div>
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-outline-secondary btn-sm" data-bs-dismiss="modal">关闭</button>
			</div>
		</div>
	</div>
</div>

@section Scripts {
<script>
	// ====================== 全局变量声明 ======================
	// 地图实例
	let map; // 主地图实例，用于显示和选择广场位置
	let coordinatesMap; // 经纬度模态框地图实例，用于显示详细位置信息

	// 操作模式标识
	let currentMode = 'add'; // 当前操作模式：'add' 或 'edit'
	let currentDeleteMode = null; // 当前删除模式：'single' 或 'multiple'




	// ====================== 页面初始化函数 ======================
	/**
	 * 页面加载完成后执行的初始化函数
	 */
	$(document).ready(function() {
		initMap(); // 初始化地图
		initTable(); // 初始化表格
		bindEventHandlers(); // 绑定事件处理程序
	});





	// ====================== 地图相关函数 ======================
	/**
	 * 初始化地图实例
	 */
	function initMap() {
		// 创建主地图实例
		map = new AMap.Map('mapContainer', {
			zoom: 12, // 初始缩放级别
			center: [116.397428, 39.90923], // 初始中心点坐标（北京）
			viewMode: '2D' // 使用2D视图模式
		});

		// 地图点击事件处理 - 点击地图时更新经纬度输入框
		map.on('click', function(e) {
			document.getElementById("info-longitude").value = e.lnglat.getLng();
			document.getElementById("info-latitude").value = e.lnglat.getLat();
		});

		// 创建经纬度模态框地图实例
		coordinatesMap = new AMap.Map('coordinatesMap', {
			zoom: 18, // 更高的缩放级别
			center: [116.397428, 39.90923], // 初始中心点坐标（北京）
			viewMode: '2D' // 使用2D视图模式
		});
	}

	/**
	 * 在主地图上添加标记
	 * param {number} latitude - 纬度
	 * param {number} longitude - 经度
	 * param {string} title - 标记标题
	 */
	function addMarkerToMap(latitude, longitude, title) {
		const marker = new AMap.Marker({
			position: new AMap.LngLat(longitude, latitude),
			title: title,
			map: map
		});

		const infoWindow = new AMap.InfoWindow({
			content: `<strong>${title}</strong><br/>纬度: ${latitude}<br/>经度: ${longitude}`,
			offset: new AMap.Pixel(0, -30)
		});

		marker.on('click', function() {
			infoWindow.open(map, marker.getPosition());
		});
	}

	/**
	 * 在经纬度模态框地图上添加标记
	 * param {number} latitude - 纬度
	 * param {number} longitude - 经度
	 * param {string} title - 标记标题
	 */
	function addMarkerToCoordinatesMap(latitude, longitude, title) {
		const marker = new AMap.Marker({
			position: new AMap.LngLat(longitude, latitude),
			title: title,
			map: coordinatesMap,
			draggable: false
		});

		const infoWindow = new AMap.InfoWindow({
			content: `<strong>${title}</strong><br/>纬度: ${latitude}<br/>经度: ${longitude}`,
			offset: new AMap.Pixel(0, -30)
		});

		marker.on('click', function() {
			infoWindow.open(coordinatesMap, marker.getPosition());
		});
	}

	// ====================== 表格相关函数 ======================
	// 表格配置对象
	const tableConfig = {
		classes: 'table table-bordered table-hover table-striped lyear-table',
		url: '/Plaza/GetPlaza', // 数据源URL
		uniqueId: 'id', // 唯一标识字段
		idField: 'id', // ID字段
		clickToSelect: true, // 点击行时选中
		dataType: 'json', // 数据类型
		method: 'get', // 请求方法
		toolbar: '#toolbar', // 工具栏选择器
		pagination: true, // 启用分页
		showColumns: true, // 显示列选择
		showRefresh: true, // 显示刷新按钮
		showButtonIcons: true, // 显示按钮图标
		showButtonText: false, // 不显示按钮文本
		showFullscreen: true, // 显示全屏按钮
		totalField: 'total', // 总记录数字段
		undefinedText: '-', // 未定义数据的显示文本
		// sortOrder: "asc", // 默认排序方式
		sidePagination: "server", // 服务端分页
		pageNumber: 1, // 默认页码
		pageSize: 5, // 默认每页记录数
		pageList: [5, 10, 25, 50, 100], // 可选的每页记录数
		paginationLoop: true, // 启用分页循环
		paginationPagesBySide: 2, // 每页显示的页码数
		buttonsClass: 'default', // 按钮类
		buttonsPrefix: 'btn', // 按钮前缀
		iconsPrefix: 'mdi', // 图标前缀
		iconSize: 'mini', // 图标大小
		icons: {
			refresh: 'mdi-refresh', // 刷新图标
			export: 'mdi-export',
			columns: 'mdi-table-column-remove', // 列选择图标
			fullscreen: 'mdi-monitor-screenshot' // 全屏图标
		},
		showExport: true, //是否显示导出按钮
		buttonsAlign: "right", //按钮位置
		exportDataType: "basic", //导出的数据类型，支持basic、all 、selected
		exportOptions: {
			ignoreColumn: [0], //导出数据忽略第一列
			fileName: '广场表', //导出数据的文件名
			worksheetName: 'sheet1', //表格工作区名称
			tableName: '广场信息表',
			excelstyles: ['background-color', 'color', 'font-size', 'font-weight'],

		},
		exportTypes: ['json', 'xml', 'csv', 'txt', 'sql', 'doc', 'excel'], //导出类型

	};

	// 表格列定义
	const columns = [{
			field: 'example',
			checkbox: true,
			widthUnit: 'rem'
		},
		{
			field: 'id',
			title: '编号',
			align: 'center',
			sortable: true,
			sortName: 'sortId',
			switchable: false,
			widthUnit: 'rem'
		},
		{
			field: 'name',
			align: 'center',
			title: '商场名称'
		},
		{
			field: 'address',
			align: 'center',
			title: '地址'
		},
		{
			field: 'coordinates',
			align: 'center',
			title: '经纬度',
			formatter: function(value, row, index) {
				const coordinates = `${row.longitude || '无'}, ${row.latitude || '无'}`;
				return `<a href="#" class="coordinates-link" data-latitude="${row.latitude}" data-longitude="${row.longitude}">${coordinates}</a>`;
			}
		},
		{
			field: 'code',
			align: 'center',
			title: '唯一标识'
		},
		{
			field: 'isDeleted',
			title: '软删除',
			formatter: function(value, row, index) {
				return row.isDeleted == 0 ?
					'<span class="badge bg-success">启用</span>' :
					row.isDeleted == 1 ?
					'<span class="badge bg-danger">禁用</span>' :
					'<span class="badge bg-secondary">未知</span>';
			}
		},
		{
			field: 'operate',
			title: '操作',
			formatter: function() {
				return `<div class="btn-group">
                                    <button class="btn btn-sm btn-indigo btn-round detial-btn" title="详情"><span class="mdi mdi-information"></span></button>
                                    <button class="btn btn-sm btn-primary btn-round edit-btn" title="编辑"><span class="mdi mdi-pencil"></span></button>
                                    <button class="btn btn-sm btn-danger btn-round del-btn" title="删除"><span class="mdi mdi-close"></span></button>
                            </div>`;
			},
			events: {
				'click .detial-btn': function(event, value, row, index) {
					event.stopPropagation();
					detial(row);
				},
				'click .edit-btn': function(event, value, row, index) {
					event.stopPropagation();
					edit(row);
				},
				'click .del-btn': function(event, value, row, index) {
					event.stopPropagation();
					del(row);
				}
			}
		}
	];

	/**
	 * 初始化表格
	 */
	function initTable() {
		$('table').bootstrapTable({
			...tableConfig,
			queryParams: function(params) {
				return {
					pageSize: params.limit,
					pageIndex: Math.floor(params.offset / params.limit) + 1,
					sort: params.sort || "Id",
					sortOrder: params.order || "asc",
					keyword: $('#searchBox').val().trim(),
					plazaName: $('#searchName').val().trim(),
					plazaAddress: $('#searchAddress').val().trim(),
					status: $('#searchStatus').val().trim()
				};
			},
			columns,
			onLoadSuccess: function(data) {
				$("[data-bs-toggle='tooltip']").tooltip();
				updateButtonState();

				const rows = Array.isArray(data) ? data : (data.rows || []);

				map.clearMap();

				rows.forEach(function(row) {
					if (row.latitude && row.longitude) {
						addMarkerToMap(row.latitude, row.longitude, row.name || '未命名');
					}
				});

				const selections = $('table').bootstrapTable('getSelections');
				if (selections.length === 1) {
					const selectedRow = selections[0];
					if (selectedRow.latitude && selectedRow.longitude) {
						map.setCenter([selectedRow.longitude, selectedRow.latitude]);
					}
				}
			},
			onCheck: updateButtonState,
			onUncheck: updateButtonState,
			onCheckAll: updateButtonState,
			onUncheckAll: updateButtonState
		});
	}

	// ====================== 事件处理函数 ======================
	/**
	 * 绑定页面事件处理程序
	 */
	function bindEventHandlers() {
		// 基本搜索
		$('#searchButton').click(performBasicSearch);
		$('#searchBox').keypress(function(e) {
			if (e.which === 13) performBasicSearch();
		});
		$('#searchBox').keydown(function(e) {
			if (e.which === 27) {
				$('#searchBox').val('');
				$('#table').bootstrapTable('refresh');
			}
		});

		// 高级搜索
		$('#searchplus-btn').click(function() {
			$('#searchModal').modal('show');
		});
		$('#clearButton').click(function() {
			$('#searchBox').val('');
			$('#searchForm')[0].reset();
			$('#table').bootstrapTable('refresh');
		});

		// 编辑按钮
		$('#edit-btn').click(function() {
			const selections = $('table').bootstrapTable('getSelections');
			if (selections.length !== 1) {
				showToast('请选择一条记录进行编辑', true);
				return;
			}
			edit(selections[0]);
		});

		// 删除按钮
		$('#del-btn').click(function() {
			const selections = $('table').bootstrapTable('getSelections');
			if (selections.length === 0) {
				showToast('请至少选择一条记录进行删除', true);
				return;
			}
			showDeleteConfirm(selections);
		});

		// 经纬度链接
		$(document).on('click', '.coordinates-link', function(e) {
			e.preventDefault();
			const latitude = $(this).data('latitude');
			const longitude = $(this).data('longitude');
			$('#coordinatesText').text(`纬度: ${latitude || '无'}, 经度: ${longitude || '无'}`);
			$('#coordinatesModal').modal('show');

			if (latitude && longitude) {
				coordinatesMap.clearMap();
				addMarkerToCoordinatesMap(latitude, longitude, '当前位置');
				coordinatesMap.setCenter([longitude, latitude]);
			} else {
				showToast('无效的经纬度数据', true);
			}
		});
	}

	/**
	 * 执行基本搜索
	 */
	function performBasicSearch() {
		const keyword = $('#searchBox').val().trim();
		$('#table').bootstrapTable('refresh', {
			query: {
				keyword: keyword
			}
		});
	}

	/**
	 * 显示删除确认对话框
	 * param {Array} selections - 选中的记录数组
	 */
	function showDeleteConfirm(selections) {
		currentDeleteMode = selections.length > 1 ? 'multiple' : 'single';
		const countInfo = selections.length > 1 ?
			`共选中 ${selections.length} 条记录` :
			`记录: ${selections[0].name}`;

		$('#deleteCountInfo').text(countInfo);
		$('#deleteConfirmModal').modal('show');
	}

	/**
	 * 确认删除操作
	 */
	function confirmDelete() {
		const selections = $('table').bootstrapTable('getSelections');
		if (selections.length === 0) {
			showToast('请至少选择一条记录进行删除', true);
			return;
		}

		const ids = selections.map(record => record.id);
		if (!ids || ids.length === 0) {
			showToast('未获取到有效的ID', true);
			return;
		}

		$.ajax({
			url: '/Plaza/DeleteRange',
			type: 'POST',
			data: {
				ids: ids
			},
			success: function(response) {
				if (response.success) {
					$('#table').bootstrapTable('refresh');
					$('#deleteConfirmModal').modal('hide');
					const message = ids.length > 1 ?
						`成功删除 ${ids.length} 条记录` :
						'成功删除记录';
					showToast(message);
				} else {
					showToast('删除失败: ' + (response.message || '请重试'), true);
				}
			},
			error: function(xhr) {
				const errorMsg = xhr.responseJSON?.message || '服务器错误';
				showToast(`操作失败: ${errorMsg}`, true);
			}
		});
	}

	// ====================== 业务操作函数 ======================
	/**
	 * 新增广场
	 */
	function add() {
		currentMode = 'add';
		$('#infoModalTitle').text('新增信息');
		$('#infoForm')[0].reset();
		$('#infoForm').find('[name="isDeleted"]').val('0');
		$('#infoModal').modal('show');
	}

	/**
	 * 编辑广场
	 * param {Object} row - 要编辑的行数据
	 */
	function edit(row) {
		currentMode = 'edit';
		$('#infoModalTitle').text('编辑信息');
		clearOtherCheckboxes(row.id);

		$('#infoForm').find('[name="id"]').val(row.id);
		$('#infoForm').find('[name="name"]').val(row.name);
		$('#infoForm').find('[name="address"]').val(row.address);
		$('#infoForm').find('[name="latitude"]').val(row.latitude);
		$('#infoForm').find('[name="longitude"]').val(row.longitude);
		$('#infoForm').find('[name="code"]').val(row.code);
		$('#infoForm').find('[name="createTime"]').val(row.createTime);
		$('#infoForm').find('[name="deleteTime"]').val(row.deleteTime);
		$('#infoForm').find('[name="isDeleted"]').val(Number(row.isDeleted));

		if (row.latitude && row.longitude) {
			map.setCenter([row.longitude, row.latitude]);
		}

		$('#infoModal').modal('show');
	}

	/**
	 * 显示广场详情
	 * param {Object} row - 要显示的行数据
	 */
	function detial(row) {
		$('#detail-id').text(row.id || '无');
		$('#detail-name').text(row.name || '无');
		$('#detail-address').text(row.address || '无');
		$('#detail-latitude').text(row.latitude || '无');
		$('#detail-longitude').text(row.longitude || '无');
		$('#detail-code').text(row.code || '无');
		const statusText = row.isDeleted == '0' ? '启用' : row.isDeleted == '1' ? '禁用' : '未知';
		$('#detail-createTime').text(row.createTime || '无');
		$('#detail-updatetime').text(row.updateTime);
		$('#detail-isDeleted').text(statusText);
		$('#detail-deletetime').text(row.deleteTime);
		$('#detailModal').modal('show');
	}

	/**
	 * 删除单条记录
	 * param {Object} row - 要删除的行数据
	 */
	function del(row) {
		showDeleteConfirm([row]);
	}

	/**
	 * 提交表单数据
	 */
	function submitInfoForm() {
		if (!validateInfoForm()) return;

		const formData = {
			name: $('#info-name').val(),
			address: $('#info-address').val(),
			latitude: $('#info-latitude').val(),
			longitude: $('#info-longitude').val(),
			code: $('#info-code').val(),
			isDeleted: $('#info-isDeleted').val() === '1'
		};

		if (currentMode === 'edit') {
			formData.id = $('#info-id').val();
		}

		const url = currentMode === 'add' ? '/Plaza/Add' : '/Plaza/Edit';
		const successMessage = currentMode === 'add' ? '新增成功' : '更新成功';

		$.ajax({
			url: url,
			type: 'POST',
			data: formData,
			success: function(response) {
				if (response.success) {
					$('#infoModal').modal('hide');
					$('#table').bootstrapTable('refresh');
					showToast(successMessage);
				} else {
					showToast(`操作失败: ${response.message || '未知错误'}`, true);
				}
			},
			error: function(xhr, status, error) {
				showToast('请求失败: ' + error, true);
			}
		});
	}

	/**
	 * 提交高级搜索表单
	 */
	function submitSearchForm() {
		const formData = $('#searchForm').serializeArray();
		const queryParams = {};

		//搜集高级搜索表单数据
		formData.forEach(item => {
			if (item.value) {
				queryParams[item.name] = item.value;
			}
		});

		const keyword = $('#searchBox').val().trim();
		if (keyword) {
			queryParams.keyword = keyword;
		}

		$('#table').bootstrapTable('refresh', {
			query: queryParams
		});

		$('#searchModal').modal('hide');
	}

	/**
	 * 重置高级搜索表单
	 */
	function resetSearchForm() {
		$('#searchForm')[0].reset();
		$('#table').bootstrapTable('refresh');
	}

	// ====================== 辅助函数 ======================
	/**
	 * 验证表单数据
	 * returns {boolean} 表单是否有效
	 */
	function validateInfoForm() {
		let isValid = true;

		$('.form-control').removeClass('is-invalid');
		$('.invalid-feedback').remove();

		$('#infoForm [required]').each(function() {
			if (!$(this).val()) {
				isValid = false;
				$(this).addClass('is-invalid');
				$(this).after('<div class="invalid-feedback">此字段为必填项</div>');
			}
		});

		if (!$('#info-latitude').val() || !$('#info-longitude').val()) {
			isValid = false;
			$('#mapContainer').after('<div class="invalid-feedback d-block">请在地图上选择位置</div>');
		}

		return isValid;
	}

	/**
	 * 清除其他复选框，只保留当前选中的记录
	 * param {number} keepId - 要保留的记录ID
	 */
	function clearOtherCheckboxes(keepId) {
		const $table = $('table');
		const data = $table.bootstrapTable('getData');
		$table.bootstrapTable('uncheckAll');
		const rowToKeep = data.find(item => item.id === keepId);
		if (rowToKeep) {
			$table.bootstrapTable('checkBy', {
				field: 'id',
				values: [keepId]
			});
		}
		updateButtonState();
	}

	/**
	 * 更新按钮状态（根据选中的记录数）
	 */
	function updateButtonState() {
		const selections = $('table').bootstrapTable('getSelections');
		const allRows = $('table').bootstrapTable('getData');
		const selectedCount = selections.length;
		const totalRows = allRows.length;

		$('#edit-btn').prop('disabled', selectedCount !== 1);
		$('#del-btn').prop('disabled', selectedCount === 0);

		const headerCheckbox = $('table').find('thead [type="checkbox"]');
		if (selectedCount === 0) {
			headerCheckbox.prop('indeterminate', false).prop('checked', false);
		} else if (selectedCount === totalRows) {
			headerCheckbox.prop('indeterminate', false).prop('checked', true);
		} else {
			headerCheckbox.prop('indeterminate', true).prop('checked', false);
		}
	}
</script>
}
