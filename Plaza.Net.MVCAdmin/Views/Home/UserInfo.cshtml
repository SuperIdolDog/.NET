
<div class="container-fluid">
    <div class="row">
        <div class="col-lg-12">
            <div class="card">
                <header class="card-header">
                    <div class="card-title">个人信息</div>
                </header>
                <div class="card-body">
                    <div class="d-flex">
                        <img src="@(Model.AvatarUrl != null ? $"http://localhost:5132/{Model.AvatarUrl.TrimStart('/')}" : "~/favicon.png")" alt="用户头像" class="avatar-xl rounded-circle me-3">
                        <div class="flex-grow-1">
                            <button class="btn btn-default" data-bs-toggle="modal" data-bs-target="#avatarModal">修改头像</button>
                            <p class="mt-1 mb-0">选择一张你喜欢的图片，裁剪后会自动生成264x264大小，上传图片大小不能超过2M。</p>
                        </div>
                    </div>
                    <hr>
                    <form id="profileForm" method="post" action="/Home/UpdateProfile" class="site-form">
                        <div class="mb-3">
                            <label for="username">用户名</label>
                            <input type="text" class="form-control" name="UserName" id="username" value="@Model.UserName" required>
                        </div>
                        <div class="mb-3">
                            <label for="email">邮箱</label>
                            <input type="email" class="form-control" name="Email" id="email" aria-describedby="emailHelp" placeholder="请输入正确的邮箱地址" value="@Model.Email" required>
                            <small id="emailHelp" class="form-text text-muted">请保证您填写的邮箱地址是正确的。</small>
                        </div>
                        <div class="mb-3">
                            <label for="nickname">昵称</label>
                            <input type="text" class="form-control" name="FullName" id="nickname" placeholder="输入您的昵称" value="@Model.FullName" required>
                        </div>
                        <div class="mb-3">
                            <label for="idNumber">身份证号</label>
                            <input type="text" class="form-control" name="IDNumber" id="idNumber" placeholder="请输入身份证号" value="@Model.IDNumber">
                        </div>
                        <div class="mb-3">
                            <label for="phone">手机号</label>
                            <input type="text" class="form-control" name="PhoneNumber" id="phone" placeholder="请输入手机号" value="@Model.PhoneNumber">
                        </div>

                        <button type="submit" class="btn btn-primary">保存</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 头像上传模态框 -->
<div class="modal fade" id="avatarModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-light">
                <h5 class="modal-title">上传头像</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="avatarForm" enctype="multipart/form-data">
                    <div class="mb-3">
                        <input type="file" class="form-control" name="file" id="avatarFile" accept="image/*" >
                        <small class="form-text text-muted">支持JPG、PNG格式，大小不超过2MB</small>
                    </div>
                    <div class="d-flex justify-content-center">
                        <img id="avatarPreview" src="@(Model.AvatarUrl != null ? $"http://localhost:5132/{Model.AvatarUrl.TrimStart('/')}" : "~/favicon.png")" alt="头像预览" class="img-thumbnail" style="max-width: 150px; max-height: 150px;">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" id="uploadAvatarBtn">上传</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function() {
            // 头像预览
            $('#avatarFile').change(function(e) {
                const file = e.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = function(e) {
                    $('#avatarPreview').attr('src', e.target.result);
                };
                reader.readAsDataURL(file);
            });

                  // 上传头像
        $('#uploadAvatarBtn').click(function() {
            const fileInput = $('#avatarFile')[0];
            const file = fileInput.files[0];

            if (!file) {
                showToast('请选择头像文件', true);
                return;
            }

            const formData = new FormData();
            formData.append('file', file);

            // 添加防伪令牌（如果启用了防伪验证）
            const token = $('input[name="__RequestVerificationToken"]').val();
            if (token) {
                formData.append('__RequestVerificationToken', token);
            }

            $.ajax({
                url: '/Home/UploadAvatar',
                type: 'POST',
                data: formData,
                processData: false,
                contentType: false,
                headers: {
                    'RequestVerificationToken': $('input[name="__RequestVerificationToken"]').val()
                },
                success: function(response) {
                    if (response.success) {
                        // 更新页面上的头像显示
                        $('.avatar-xl').attr('src', response.avatarUrl);
                        $('#avatarPreview').attr('src', response.avatarUrl);

                        // 关闭模态框
                        $('#avatarModal').modal('hide');
                          window.parent.location.reload();
                        // 显示成功消息
                        showToast('头像上传成功');
                      
                    } else {
                        showToast('头像上传失败: ' + (response.message || '未知错误'), true);
                    }
                },
                error: function(xhr, status, error) {
                    const errorMsg = xhr.responseJSON?.message || xhr.statusText || '服务器错误';
                    showToast('头像上传失败: ' + errorMsg, true);
                }
            });
        });

            // 表单提交
            $('#profileForm').submit(function(e) {
                e.preventDefault();

                const form = $(this);
                const formData = form.serialize();

                $.ajax({
                    url: form.attr('action'),
                    type: form.attr('method'),
                    data: formData,
                   success: function(response) {
            if (response.success) {
                // 检查是否存在 redirectUrl
                if (response.redirectUrl) {
                    // 如果有 redirectUrl，则重定向
                    window.parent.location.href = response.redirectUrl;
                } else {
                    // 否则，更新表单数据
                    $('#username').val(response.user.UserName);
                    $('#email').val(response.user.Email);
                    $('#nickname').val(response.user.FullName);
                    $('#idNumber').val(response.user.IDNumber);
                    $('#phone').val(response.user.PhoneNumber);

                    showToast(response.message);
                }
            } else {
                showToast(response.message, true);
            }
        },
                    error: function(xhr, status, error) {
                        const errorMsg = xhr.responseJSON?.message || xhr.statusText || '服务器错误';
                        showToast('操作失败: ' + errorMsg, true);
                    }
                });
            });
        });
    </script>
}
